<?php
/**
 * @file
 * Install functions for Fial core module.
 */

/**
 * Implements hook_install().
 */
function fial_core_install() {
}

/**
 * Implements hook_enable().
 */
function fial_core_enable() {
  theme_enable(array('fial_theme'));
  variable_set('theme_default', 'fial_theme');
}

/**
 * Implements hook_disable().
 */
function fial_core_disable() {

}

/**
 * Enable Views Slideshow Configurable Controls, allow anonymous users to see
 * the menu blocks, add 'dashboard' menu link, grant authenticated users the
 * 'access collabco dashboard' permission, update Collabco Profile Blocks,
 * update Hubs link to say Groups, update hubs intro text, create 'Contact' page
 * stub and revert features and flush caches.
 */
function fial_core_update_7101() {
  // Enable Views Slideshow Configurable Controls.
  module_enable(array('vscc'));

  // Allow anonymous users to see the menu blocks.
  $blocks = array(
    'menu-meta-secondary-menu' => 'menu',
    'main-menu' => 'system'
  );
  foreach ($blocks as $delta => $module) {
    db_insert('block_role')
      ->fields(array(
        'module' => $module,
        'delta' => $delta,
        'rid' => DRUPAL_ANONYMOUS_RID
      ))
      ->execute();
  }

  // Add 'dashboard' menu link.
  $menu_link = array(
    'menu_name' => 'main-menu',
    'plid' => 0,
    'link_path' => 'dashboard',
    'router_path' => 'dashboard',
    'link_title' => t('Dashboard'),
    'weight' => -49,
  );
  menu_link_save($menu_link);

  // Grant authenticated users the 'access collabco dashboard' permission.
  user_role_grant_permissions(DRUPAL_AUTHENTICATED_RID, array('access collabco dashboard'));

  // Update Collabco Profile Blocks.
  db_delete('block')
    ->condition('module', 'collabco_profile_block')
    ->execute();

  db_update('block')
    ->fields(array(
      'module' => 'collabco_profile_block',
    ))
    ->condition('module', 'iin_profile_block')
    ->execute();

  db_update('block')
    ->fields(array(
      'delta' => 'collabco_profile_block',
    ))
    ->condition('delta', 'iin_profile_block')
    ->execute();

  db_update('block_role')
    ->fields(array(
      'module' => 'collabco_profile_block'
    ))
    ->condition('module', 'iin_profile_block')
    ->execute();

  db_update('block_role')
    ->fields(array(
      'delta' => 'iin_profile_block'
    ))
    ->condition('delta', 'iin_profile_block')
    ->execute();

  // Update hubs menu link.
  $menu_item = menu_link_load(1310);
  $menu_item['link_title'] = 'Groups';
  menu_link_save($menu_item);

  // Update text on hubs intro block.
  db_query("UPDATE {block_custom} SET body=replace(body, 'Hubs', 'Groups') WHERE bid = 16");

<<<<<<< Updated upstream
  // Create 'Contact' page stub.
  $node = new stdClass();
  $node->type = 'basic_page';
  node_object_prepare($node);

  $node->uid = 1;
  $node->title = 'Contact';
  $node->language = LANGUAGE_NONE;
  node_save($node);

  $path = array(
    'source' => "node/{$node->nid}",
    'alias' => 'contact',
  );
  path_save($path);

  $menu_link = array(
    'menu_name' => 'menu-meta-secondary-menu',
    'plid' => 0,
    'link_path' => 'contact',
    'router_path' => 'contact',
    'link_title' => t('Contact'),
    'weight' => 10,
  );
  menu_link_save($menu_link);

  // Update News menu link.
  $menu_item = menu_link_load(1007);
  $menu_item['link_title'] = 'Our News';
  menu_link_save($menu_item);

  // Revert features and flush caches.
  _fial_core_flush_revert();
}

/**
 * Helper function; Flush caches and revert features.
 */
function _fial_core_flush_revert() {
  drupal_flush_all_caches();
  features_revert(array('fial_core' => array()));
}
